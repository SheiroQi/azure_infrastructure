name: Terraform Plan

# Trigger: 什么时候触发？(Rule 4: Event Driven)
# 当 main 分支有 push 动作，或者有 Pull Request 时触发
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# 权限配置 (P7 Best Practice)
permissions:
  contents: read

jobs:
  terraform-plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest # 使用 GitHub 提供的最新 Ubuntu Runner

    # 环境变量注入
    env:
      # 告诉 Terraform 它是自动化的，不要弹窗问 yes/no
      TF_IN_AUTOMATION: "true" 

    steps:
      # Step 1: 把代码从仓库拉到 Runner 里
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Restore SSH Key File
        run: echo "${{ secrets.AZURE_SSH_KEY }}" > my_azure_key.pub
      # Step 2: 登录 Azure (使用刚才配的 Secret)
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 3: 安装 Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest # 锁定版本 (Rule 4: Determinism)

      # Step 4: 初始化 (下载插件)
      # Step 4: 初始化 (下载插件)
      - name: Terraform Init
        id: init
        env:
          # P7 修正: 显式注入所有 Service Principal 凭证
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init
      # Step 5: 格式检查 (P7 Quality Gate)
      # 如果格式乱了，直接报错，不允许脏代码入库
      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      # Step 6: 验证逻辑 (Validate)
      - name: Terraform Validate
        id: validate
        run: terraform validate

# Step 7: 预演 (Plan)
      - name: Terraform Plan
        id: plan
        # P7 关键技巧：通过环境变量注入所有缺失的参数
        # 对应你的 variables.tf 里那三个没有 default 的变量
        env:
          TF_VAR_env: "Dev"                      # 对应 variable "env"
          TF_VAR_vm_size: "Standard_D2s_v3"      # 对应 variable "vm_size"
          TF_VAR_enable_monitoring: false        # 对应 variable "enable_monitoring"
        run: terraform plan -no-color
